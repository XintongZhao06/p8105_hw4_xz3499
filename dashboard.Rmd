---
title: "NOAA Weather Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    fig_width: 10
    fig_height: 6
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(plotly)
library(flexdashboard)
library(p8105.datasets)

data("ny_noaa")

noaa_data <- ny_noaa %>%
  mutate(
    date = as.Date(date),
    year = year(date),
    month = month(date, label = TRUE),
    month_num = month(date),
    # Season classification
    season = case_when(
      month_num %in% c(12, 1, 2) ~ "Winter",
      month_num %in% c(3, 4, 5) ~ "Spring", 
      month_num %in% c(6, 7, 8) ~ "Summer",
      month_num %in% c(9, 10, 11) ~ "Fall",
      TRUE ~ "Unknown"
    ),
    # Convert to Celsius
    tmax = as.numeric(tmax)/10,
    tmin = as.numeric(tmin)/10,
    avg_temp = (tmax + tmin) / 2,
    temp_range = tmax - tmin,
    # Convert to millimeters
    prcp_mm = as.numeric(prcp) / 10,
    snwd = as.numeric(snwd),
    snow = as.numeric(snow)
  ) %>% 
  filter(year >= 2000 & year <= 2010) %>%
  filter(!is.na(tmax) & !is.na(tmin) & !is.na(prcp_mm))

# Summary of seasonal data
seasonal_summary <- noaa_data %>%
  filter(!is.na(season) & season != "Unknown") %>%
  group_by(year, season) %>%
  summarise(
    avg_temp = mean(avg_temp, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(season = factor(season, levels = c("Winter", "Spring", "Summer", "Fall")))

# Summary of monthly data 
monthly_climate <- noaa_data %>%
  group_by(month) %>%
  summarise(
    avg_high = mean(tmax, na.rm = TRUE),
    avg_low = mean(tmin, na.rm = TRUE),
    avg_precip = mean(prcp_mm, na.rm = TRUE),
    precip_days = mean(prcp_mm > 0, na.rm = TRUE) * 100,
    .groups = 'drop'
  )

# Summary of extreme weather data
extreme_events <- noaa_data %>%
  group_by(year) %>%
  summarise(
    max_temp = max(tmax, na.rm = TRUE),
    min_temp = min(tmin, na.rm = TRUE),
    max_prcp = max(prcp_mm, na.rm = TRUE),
    total_snow_days = sum(snow > 0, na.rm = TRUE),
    .groups = 'drop'
  )

# Summary of winter data
winter_data <- noaa_data %>%
  filter(season == "Winter") %>%
  group_by(year) %>%
  summarise(
    avg_snow_depth = mean(snwd, na.rm = TRUE),
    snow_days = sum(snow > 0, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(avg_snow_depth = ifelse(is.infinite(avg_snow_depth) | is.na(avg_snow_depth), 0, avg_snow_depth))

# Summary of normal climate data
climate_normals <- noaa_data %>%
  group_by(month) %>%
  summarise(
    temp_high_normal = mean(tmax, na.rm = TRUE),
    temp_low_normal = mean(tmin, na.rm = TRUE),
    temp_high_record = max(tmax, na.rm = TRUE),
    temp_low_record = min(tmin, na.rm = TRUE),
    .groups = 'drop'
  )

# Summary of extreme temperature data
extreme_days <- noaa_data %>%
  mutate(
    hot_day = tmax > 30,
    freezing_day = tmax < 0
  ) %>%
  group_by(year, season) %>%
  summarise(
    hot_days = sum(hot_day, na.rm = TRUE),
    freezing_days = sum(freezing_day, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = c(hot_days, freezing_days), names_to = "type", values_to = "days")
```

 

### 🌡️ Seasonal Temperature Trends

```{r}
seasonal_summary |>
  mutate(
    label = str_c("Year: ", year, "\nSeason: ", season, "\nAvg Temp: ", round(avg_temp, 1), "°C")
  ) |>
  plot_ly(
    x = ~year, y = ~avg_temp, color = ~season,
    text = ~label, alpha = 0.7,
    type = "scatter", mode = "markers"
  ) |>
  layout(
    title = "Seasonal Temperature Trends (2000-2010)",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Average Temperature (°C)")
  )
```

 

### 🌧️ Precipitation Patterns Analysis

```{r}
monthly_climate |>
  mutate(
    month = fct_reorder(month, avg_precip)
  ) |>
  plot_ly(
    x = ~month, y = ~avg_precip,
    type = "bar"
  ) |>
  layout(
    title = "Monthly Precipitation Patterns",
    xaxis = list(title = "Month"),
    yaxis = list(title = "Avg Precipitation (mm)")
  )
```

 
### 📦 Monthly Temperature Distribution

```{r}
noaa_data |>
  mutate(
    month = fct_reorder(month, avg_temp)
  ) |>
  plot_ly(
    x = ~month, y = ~avg_temp, color = ~month,
    type = "box", colors = "viridis"
  ) |>
  layout(
    title = "Monthly Temperature Distribution",
    xaxis = list(title = "Month"),
    yaxis = list(title = "Temperature (°C)"),
    showlegend = FALSE
  )
```

 

### ❄️ Winter Conditions Analysis

```{r}
winter_data |>
  plot_ly(
    x = ~year, y = ~avg_snow_depth,
    type = "bar",
    name = "Avg Snow Depth"
  ) |>
  add_trace(
    x = ~year, y = ~snow_days,
    type = "scatter", mode = "lines+markers",
    name = "Snow Days",
    yaxis = "y2"
  ) |>
  layout(
    title = "Winter Conditions Analysis",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Average Snow Depth (mm)"),
    yaxis2 = list(
      title = "Number of Snow Days",
      overlaying = "y",
      side = "right"
    )
  )
```

 

### 📊 Climate Normals Comparison

```{r}
climate_normals |>
  plot_ly(
    x = ~month, y = ~temp_high_normal,
    type = "scatter", mode = "lines+markers",
    name = "Avg High Temp",
    line = list(color = 'lightblue', width = 3),
    marker = list(size = 6, color = 'lightblue')
  ) |>
  add_trace(
    y = ~temp_low_normal,
    name = "Avg Low Temp",
    line = list(color = 'lightpink', width = 3),
    marker = list(size = 6, color = 'lightpink')
  ) |>
  layout(
    title = "Climate Normals Comparison",
    xaxis = list(title = "Month"),
    yaxis = list(title = "Temperature (°C)")
  )
```

 

### 🔥 Extreme Temperature Analysis

```{r}
extreme_days |>
  mutate(
    type = fct_reorder(type, days)
  ) |>
  plot_ly(
    x = ~year, y = ~days, color = ~type,
    type = "bar"
  ) |>
  layout(
    title = "Extreme Temperature Days by Season",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Number of Days"),
    barmode = "group"
  )
```

