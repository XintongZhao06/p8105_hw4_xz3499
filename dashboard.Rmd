
---
title: "NOAA Weather Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(plotly)
library(flexdashboard)
library(p8105.datasets)
library(shiny)

# ËΩΩÂÖ• NOAA Êï∞ÊçÆÈõÜ
data("ny_noaa")

noaa_processed <- ny_noaa %>% 
  mutate(
    date = as.Date(date),
    year = year(date),
    month = month(date, label = TRUE),
    prcp_mm = as.numeric(prcp) / 10,
    tmax = as.numeric(tmax)/10,
    tmin = as.numeric(tmin)/10
  ) %>% 
  filter(year >= 2000 & year <= 2010) %>%
  filter(!is.na(tmax) & !is.na(tmin) & !is.na(prcp_mm) & !is.na(snwd)) %>%
  filter(prcp_mm >= 0 & prcp_mm <= 500,
         snow >= 0 & snow <= 1000) 
```

---

```{r}
# ‰æßËæπÊ†èÊéß‰ª∂ - ÁßªÈô§ÊâãÂä®ËåÉÂõ¥ÈÄâÊã©
selectInput(
  "selected_year",
  "Select Year:",
  choices = c("All", 2000:2010),
  selected = "All"
)

selectInput(
  "plot_type",
  "Temperature Plot Type:",
  choices = c("Line", "Bar", "Boxplot"),
  selected = "Line"
)

checkboxGroupInput(
  "selected_months",
  "Select Months:",
  choices = month.abb,
  selected = month.abb,
  inline = TRUE
)
```

---


### üå°Ô∏è Temperature Trends

```{r}
renderPlotly({
  df <- noaa_processed
  if (input$selected_year != "All") {
    df <- df[df$year == as.numeric(input$selected_year), ]
  }
  
  df <- df %>% filter(month %in% input$selected_months)
  
  if (input$plot_type == "Line") {
    df_summary <- df %>%
      group_by(month) %>%
      summarise(
        mean_tmax = mean(tmax, na.rm = TRUE),
        mean_tmin = mean(tmin, na.rm = TRUE),
        .groups = "drop"
      )
    
    plot_ly(df_summary) %>%
      add_trace(x = ~month, y = ~mean_tmax, type = 'scatter', mode = 'lines+markers',
                name = 'Max Temp', 
                line = list(color = '#1E3A8A', width = 3), 
                marker = list(color = '#1E3A8A', size = 8)) %>%
      add_trace(x = ~month, y = ~mean_tmin, type = 'scatter', mode = 'lines+markers',
                name = 'Min Temp', 
                line = list(color = '#60A5FA', width = 3), 
                marker = list(color = '#60A5FA', size = 8)) %>%
      layout(
        title = list(text = "Monthly Temperature Trends", font = list(size = 16, color = '#1E3A8A')),
        xaxis = list(title = "Month", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
        yaxis = list(title = "Temperature (¬∞C)", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
        plot_bgcolor = 'rgba(255,255,255,0.9)',
        paper_bgcolor = 'rgba(255,255,255,0.9)',
        font = list(color = '#1E3A8A'),
        showlegend = TRUE
      )
    
  } else if (input$plot_type == "Bar") {
    df_summary <- df %>%
      group_by(month) %>%
      summarise(
        mean_tmax = mean(tmax, na.rm = TRUE),
        mean_tmin = mean(tmin, na.rm = TRUE),
        .groups = "drop"
      )
    
    plot_ly(df_summary) %>%
      add_trace(x = ~month, y = ~mean_tmax, type = 'bar', name = 'Max Temp',
                marker = list(color = '#1E3A8A')) %>%
      add_trace(x = ~month, y = ~mean_tmin, type = 'bar', name = 'Min Temp',
                marker = list(color = '#60A5FA')) %>%
      layout(
        title = list(text = "Monthly Temperature Comparison", font = list(size = 16, color = '#1E3A8A')),
        xaxis = list(title = "Month", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
        yaxis = list(title = "Temperature (¬∞C)", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
        barmode = 'group',
        plot_bgcolor = 'rgba(255,255,255,0.9)',
        paper_bgcolor = 'rgba(255,255,255,0.9)',
        font = list(color = '#1E3A8A')
      )
    
  } else { # Boxplot
    plot_ly(df, x = ~month, y = ~tmax, type = 'box', 
            name = 'Max Temp', boxpoints = 'outliers',
            marker = list(color = '#1E3A8A'),
            line = list(color = '#1E3A8A')) %>%
      add_trace(x = ~month, y = ~tmin, type = 'box', 
                name = 'Min Temp', boxpoints = 'outliers',
                marker = list(color = '#60A5FA'),
                line = list(color = '#60A5FA')) %>%
      layout(
        title = list(text = "Temperature Distribution by Month", font = list(size = 16, color = '#1E3A8A')),
        xaxis = list(title = "Month", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
        yaxis = list(title = "Temperature (¬∞C)", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
        plot_bgcolor = 'rgba(255,255,255,0.9)',
        paper_bgcolor = 'rgba(255,255,255,0.9)',
        font = list(color = '#1E3A8A')
      )
  }
})
```

---

### üåßÔ∏è Precipitation Distribution

```{r}
renderPlotly({
  df <- noaa_processed %>%
    filter(!is.na(prcp_mm))
  
  if (input$selected_year != "All") {
    df <- df[df$year == as.numeric(input$selected_year), ]
  }
  
  df <- df %>% filter(month %in% input$selected_months)
  
  plot_ly(df,
          x = ~prcp_mm,
          type = 'histogram',
          nbinsx = 30,
          marker = list(
            color = '#3B82F6',
            line = list(color = '#1D4ED8', width = 2)
          )) %>%
    layout(
      title = list(text = "Precipitation Distribution", font = list(size = 16, color = '#1E3A8A')),
      xaxis = list(title = "Precipitation (mm)", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
      yaxis = list(title = "Frequency", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
      plot_bgcolor = 'rgba(255,255,255,0.9)',
      paper_bgcolor = 'rgba(255,255,255,0.9)',
      font = list(color = '#1E3A8A')
    )
})
```

---

### ‚ùÑÔ∏è Snow Depth by Year

```{r}
renderPlotly({
  df <- noaa_processed %>%
    filter(!is.na(snwd) & !is.na(tmax) & !is.na(tmin) & snwd > 0) %>%
    mutate(avg_temp = (tmax + tmin) / 2)  # ËÆ°ÁÆóÂπ≥ÂùáÊ∏©Â∫¶
  
  if (input$selected_year != "All") {
    df <- df[df$year == as.numeric(input$selected_year), ]
  }
  
  df <- df %>% filter(month %in% input$selected_months)
  
  # ÊäΩÊ†∑ÈÅøÂÖçËøáÂ∫¶ÁªòÂà∂
  if (nrow(df) > 1000) {
    set.seed(123)
    df <- df %>% sample_n(1000)
  }
  
  plot_ly(df,
          x = ~avg_temp,  # Êîπ‰∏∫Âπ≥ÂùáÊ∏©Â∫¶
          y = ~snwd,
          type = 'scatter',
          mode = 'markers',
          marker = list(
            size = 10,
            opacity = 0.7,
            color = ~snwd,  # Êîπ‰∏∫Áî®Èõ™Ê∑±ÂÄº‰Ωú‰∏∫È¢úËâ≤
            colorscale = 'Blues',
            showscale = TRUE,
            colorbar = list(title = "Snow Depth (mm)", titlefont = list(color = '#1E3A8A'))
          ),
          text = ~paste("Date:", date, 
                       "<br>Month:", month,
                       "<br>Avg Temp:", round(avg_temp, 1), "¬∞C", 
                       "<br>Snow Depth:", snwd, "mm"),
          hoverinfo = 'text') %>%
    layout(
      title = list(text = "Snow Depth vs Average Temperature", font = list(size = 16, color = '#1E3A8A')),
      xaxis = list(title = "Average Temperature (¬∞C)", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
      yaxis = list(title = "Snow Depth (mm)", gridcolor = 'rgba(59, 130, 246, 0.2)', color = '#1E3A8A'),
      plot_bgcolor = 'rgba(255,255,255,0.9)', 
      paper_bgcolor = 'rgba(255,255,255,0.9)',
      font = list(color = '#1E3A8A')
    )
})
```


