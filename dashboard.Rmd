---
title: "NOAA Weather Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    fig_width: 10
    fig_height: 6
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(plotly)
library(flexdashboard)
library(p8105.datasets)

data("ny_noaa")

noaa_data <- ny_noaa %>%
  mutate(
    date = as.Date(date),
    year = year(date),
    month = month(date, label = TRUE),
    month_num = month(date),
    # Season classification
    season = case_when(
      month_num %in% c(12, 1, 2) ~ "Winter",
      month_num %in% c(3, 4, 5) ~ "Spring", 
      month_num %in% c(6, 7, 8) ~ "Summer",
      month_num %in% c(9, 10, 11) ~ "Fall",
      TRUE ~ "Unknown"
    ),
    # Convert to Celsius
    tmax = as.numeric(tmax)/10,
    tmin = as.numeric(tmin)/10,
    avg_temp = (tmax + tmin) / 2,
    temp_range = tmax - tmin,
    # Convert to millimeters
    prcp_mm = as.numeric(prcp) / 10,
    snwd = as.numeric(snwd),
    snow = as.numeric(snow)
  ) %>% 
  filter(year >= 2000 & year <= 2010) %>%
  filter(!is.na(tmax) & !is.na(tmin) & !is.na(prcp_mm))

# Summary of seasonal data
seasonal_summary <- noaa_data %>%
  filter(!is.na(season) & season != "Unknown") %>%
  group_by(year, season) %>%
  summarise(
    avg_temp = mean(avg_temp, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(season = factor(season, levels = c("Winter", "Spring", "Summer", "Fall")))

# Summary of monthly data 
monthly_climate <- noaa_data %>%
  group_by(month) %>%
  summarise(
    avg_high = mean(tmax, na.rm = TRUE),
    avg_low = mean(tmin, na.rm = TRUE),
    avg_precip = mean(prcp_mm, na.rm = TRUE),
    precip_days = mean(prcp_mm > 0, na.rm = TRUE) * 100,
    .groups = 'drop'
  )

# Summary of extreme weather data
extreme_events <- noaa_data %>%
  group_by(year) %>%
  summarise(
    max_temp = max(tmax, na.rm = TRUE),
    min_temp = min(tmin, na.rm = TRUE),
    max_prcp = max(prcp_mm, na.rm = TRUE),
    total_snow_days = sum(snow > 0, na.rm = TRUE),
    .groups = 'drop'
  )

# Summary of winter data
winter_data <- noaa_data %>%
  filter(season == "Winter") %>%
  group_by(year) %>%
  summarise(
    avg_snow_depth = mean(snwd, na.rm = TRUE),
    snow_days = sum(snow > 0, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(avg_snow_depth = ifelse(is.infinite(avg_snow_depth) | is.na(avg_snow_depth), 0, avg_snow_depth))

# Summary of normal climate data
climate_normals <- noaa_data %>%
  group_by(month) %>%
  summarise(
    temp_high_normal = mean(tmax, na.rm = TRUE),
    temp_low_normal = mean(tmin, na.rm = TRUE),
    temp_high_record = max(tmax, na.rm = TRUE),
    temp_low_record = min(tmin, na.rm = TRUE),
    .groups = 'drop'
  )

# Summary of extreme temperature data
extreme_days <- noaa_data %>%
  mutate(
    hot_day = tmax > 30,
    freezing_day = tmax < 0
  ) %>%
  group_by(year, season) %>%
  summarise(
    hot_days = sum(hot_day, na.rm = TRUE),
    freezing_days = sum(freezing_day, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = c(hot_days, freezing_days), names_to = "type", values_to = "days")
```

### üå°Ô∏è Seasonal Temperature Trends

```{r}
plot_ly(seasonal_summary, x = ~year, y = ~avg_temp, color = ~season,
        colors = c("#1E40AF", "#3B82F6", "#60A5FA", "#93C5FD")) %>%
  add_trace(type = 'scatter', mode = 'lines+markers',
            line = list(width = 3),
            marker = list(size = 8)) %>%
  layout(
    title = list(text = "Seasonal Temperature Trends (2000-2010)", 
                 font = list(size = 16, color = '#1E3A8A')),
    xaxis = list(title = "Year", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    yaxis = list(title = "Average Temperature (¬∞C)", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    plot_bgcolor = 'rgba(248, 250, 252, 0.8)',
    paper_bgcolor = 'rgba(248, 250, 252, 1)',
    font = list(color = '#1E3A8A'),
    showlegend = TRUE
  )
```

### üåßÔ∏è Precipitation Patterns Analysis

```{r}
plot_ly(monthly_climate) %>%
  add_trace(x = ~month, y = ~avg_precip, type = 'bar', 
            name = 'Avg Precipitation',
            marker = list(color = '#3B82F6')) %>%
  add_trace(x = ~month, y = ~precip_days, type = 'scatter', mode = 'lines+markers',
            name = 'Rainy Days (%)', yaxis = 'y2',
            line = list(color = '#1E40AF', width = 3),
            marker = list(color = '#1E40AF')) %>%
  layout(
    title = list(text = "Monthly Precipitation Patterns", 
                 font = list(size = 16, color = '#1E3A8A')),
    xaxis = list(title = "Month", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    yaxis = list(title = "Avg Precipitation (mm)", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    yaxis2 = list(title = "Rainy Days (%)", overlaying = "y", side = "right",
                 gridcolor = 'rgba(96, 165, 250, 0.1)'),
    plot_bgcolor = 'rgba(248, 250, 252, 0.8)',
    paper_bgcolor = 'rgba(248, 250, 252, 1)',
    font = list(color = '#1E3A8A')
  )
```

### üì¶ Seasonal Temperature Distribution

```{r}
# ‰ΩøÁî®Áé∞ÊúâÁöÑnoaa_dataÂàõÂª∫Â≠£ËäÇÊ∏©Â∫¶ÂàÜÂ∏ÉÊï∞ÊçÆ
seasonal_temp_dist <- noaa_data %>%
  filter(!is.na(season) & season != "Unknown") %>%
  mutate(season = factor(season, levels = c("Winter", "Spring", "Summer", "Fall")))

# ÂàõÂª∫ÁÆ±Á∫øÂõæÂ±ïÁ§∫ÂêÑÂ≠£ËäÇÊ∏©Â∫¶ÂàÜÂ∏É
plot_ly(seasonal_temp_dist, y = ~avg_temp, color = ~season, type = "box",
        colors = c("#1E40AF", "#3B82F6", "#60A5FA", "#93C5FD"),
        boxpoints = "outliers",  # ÊòæÁ§∫ÂºÇÂ∏∏ÂÄº
        marker = list(size = 4),
        line = list(width = 2)) %>%
  layout(
    title = list(text = "Seasonal Temperature Distribution", 
                 font = list(size = 16, color = '#1E3A8A')),
    xaxis = list(title = "Season", gridcolor = 'rgba(96, 165, 250, 0.3)',
                 tickfont = list(color = '#1E3A8A')),
    yaxis = list(title = "Temperature (¬∞C)", gridcolor = 'rgba(96, 165, 250, 0.3)',
                 tickfont = list(color = '#1E3A8A')),
    plot_bgcolor = 'rgba(248, 250, 252, 0.8)',
    paper_bgcolor = 'rgba(248, 250, 252, 1)',
    font = list(color = '#1E3A8A'),
    showlegend = FALSE  # Áî±‰∫éxËΩ¥Â∑≤ÁªèÊòæÁ§∫Â≠£ËäÇÔºåÂõæ‰æãÂèØ‰ª•ÈöêËóè
  )
```

---

### ‚ùÑÔ∏è Winter Conditions Analysis

```{r}
plot_ly(winter_data) %>%
  add_trace(x = ~year, y = ~avg_snow_depth, type = 'bar',
            name = 'Avg Snow Depth (mm)',
            marker = list(color = '#60A5FA'),
            text = ~paste("Year:", year, "<br>Avg Snow Depth:", round(avg_snow_depth, 1), "mm"),
            hoverinfo = 'text') %>%
  add_trace(x = ~year, y = ~snow_days, type = 'scatter', mode = 'lines+markers',
            name = 'Snow Days', yaxis = 'y2',
            line = list(color = '#1E3A8A', width = 3),
            marker = list(color = '#1E3A8A', size = 8),
            text = ~paste("Year:", year, "<br>Snow Days:", snow_days),
            hoverinfo = 'text') %>%
  layout(
    title = list(text = "Winter Conditions Analysis", 
                 font = list(size = 16, color = '#1E3A8A')),
    xaxis = list(title = "Year", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    yaxis = list(title = "Average Snow Depth (mm)", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    yaxis2 = list(title = "Number of Snow Days", overlaying = "y", side = "right",
                 gridcolor = 'rgba(96, 165, 250, 0.1)'),
    plot_bgcolor = 'rgba(248, 250, 252, 0.8)',
    paper_bgcolor = 'rgba(248, 250, 252, 1)',
    font = list(color = '#1E3A8A')
  )
```

### üìä Climate Normals Comparison

```{r}
plot_ly(climate_normals, x = ~month) %>%
  add_trace(y = ~temp_high_normal, type = 'scatter', mode = 'lines',
            name = 'Avg High Temp', 
            line = list(color = 'lightpink', width = 4)) %>%
  add_trace(y = ~temp_low_normal, type = 'scatter', mode = 'lines',
            name = 'Avg Low Temp',
            line = list(color = '#3B82F6', width = 4)) %>%
  add_trace(y = ~temp_high_record, type = 'scatter', mode = 'markers',
            name = 'Record High', 
            marker = list(color = 'lightpink', size = 8, symbol = 'triangle-up')) %>%
  add_trace(y = ~temp_low_record, type = 'scatter', mode = 'markers',
            name = 'Record Low',
            marker = list(color = '#1E40AF', size = 8, symbol = 'triangle-down')) %>%
  layout(
    title = list(text = "Climate Normals vs Records", 
                 font = list(size = 16, color = '#1E3A8A')),
    xaxis = list(title = "Month", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    yaxis = list(title = "Temperature (¬∞C)", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    plot_bgcolor = 'rgba(248, 250, 252, 0.8)',
    paper_bgcolor = 'rgba(248, 250, 252, 1)',
    font = list(color = '#1E3A8A')
  )
```

### üî• Heat and Freezing Analysis

```{r}
plot_ly(extreme_days, x = ~year, y = ~days, color = ~type, type = 'bar') %>%
  layout(
    title = list(text = "Extreme Temperature Days by Season", 
                 font = list(size = 16, color = '#1E3A8A')),
    xaxis = list(title = "Year", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    yaxis = list(title = "Number of Days", gridcolor = 'rgba(96, 165, 250, 0.3)'),
    barmode = 'group',
    plot_bgcolor = 'rgba(248, 250, 252, 0.8)',
    paper_bgcolor = 'rgba(248, 250, 252, 1)',
    font = list(color = '#1E3A8A')
  )
```
